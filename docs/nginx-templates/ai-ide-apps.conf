# Applit Static App Deployment Configuration
# This nginx config enables path-based routing for deployed workspace apps
# Install location: /etc/nginx/sites-available/ai-ide-apps.conf
# Enable: sudo ln -s /etc/nginx/sites-available/ai-ide-apps.conf /etc/nginx/sites-enabled/
# Reload: sudo systemctl reload nginx

# Root directory for deployed apps
# Each workspace gets: /var/www/ai-ide/<workspaceId>/current -> <timestamp>
# Example: /var/www/ai-ide/abc123/current -> /var/www/ai-ide/abc123/20250114120000

# Pattern: /apps/<workspaceId>/*
location ~ ^/apps/([a-zA-Z0-9\-]+)(/.*)$ {
    set $workspace_id $1;
    set $file_path $2;
    
    alias /var/www/ai-ide/$workspace_id/current$file_path;
    
    # SPA fallback - try file, then directory index, then /index.html
    try_files $uri $uri/ /apps/$workspace_id/index.html =404;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # CORS headers (adjust as needed)
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    
    # Cache static assets
    location ~ \.(jpg|jpeg|png|gif|ico|svg|css|js|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Disable caching for HTML
    location ~ \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
}

# Optional: Redirect /apps/<workspaceId> to /apps/<workspaceId>/
location ~ ^/apps/([a-zA-Z0-9\-]+)$ {
    return 301 /apps/$1/;
}
